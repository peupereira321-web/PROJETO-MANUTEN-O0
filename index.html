<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PCM - Suporte Manutenção</title>
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

  <style>
    :root{
      --bg: #0f172a; --surface: #1e293b; --card-bg: rgba(30, 41, 59, 0.7);
      --border: rgba(255,255,255,0.08); --text-main: #f8fafc; --text-muted: #94a3b8;
      --primary: #3b82f6; --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --info: #06b6d4; --purple: #8b5cf6;
      --radius: 8px; --font: 'Segoe UI', system-ui, sans-serif;
    }
    * { box-sizing: border-box; }
    
    body {
      margin: 0; font-family: var(--font); background-color: var(--bg);
      color: var(--text-main); height: 100vh; overflow: hidden;
      display: flex; flex-direction: column;
    }
    
    header {
      background: rgba(15, 23, 42, 0.9); border-bottom: 1px solid var(--border);
      padding: 0 20px; flex-shrink: 0; height: 60px; display: flex; align-items: center;
    }
    .top-bar { width: 100%; display: flex; justify-content: space-between; align-items: center; }
    .brand { display: flex; align-items: center; gap: 10px; }
    .brand-text h1 { margin: 0; font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    .brand-text p { margin: 0; font-size: 10px; color: var(--text-muted); }

    /* Relógio e Data */
    .datetime-box {
        display: flex; flex-direction: column; align-items: flex-end; margin-right: 15px;
    }
    .clock-time { font-size: 18px; font-weight: 700; font-variant-numeric: tabular-nums; line-height: 1; color: var(--primary); }
    .clock-date { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }

    nav { display: flex; gap: 4px; background: rgba(0,0,0,0.2); padding: 3px; border-radius: 99px; border: 1px solid var(--border); }
    .tab {
      background: transparent; border: none; color: var(--text-muted);
      padding: 5px 12px; border-radius: 99px; cursor: pointer;
      font-weight: 600; font-size: 12px; display: flex; align-items: center; gap: 5px;
    }
    .tab:hover { color: var(--text-main); }
    .tab.active { background: var(--surface); color: var(--primary); border: 1px solid var(--border); }
    
    main.wrap {
      flex: 1; padding: 15px; display: flex; flex-direction: column; overflow: hidden; width: 100%; max-width: 100%;
    }

    .section { display: none; height: 100%; flex-direction: column; gap: 15px; }
    .section.active { display: flex; }

    /* KPIs */
    .kpi-row {
      display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; flex-shrink: 0;
    }
    .kpi-box {
      background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius);
      padding: 10px 15px; display: flex; align-items: center; justify-content: space-between;
    }
    .kpi-val { font-size: 24px; font-weight: 800; line-height: 1; }
    
    /* Layout Dividido */
    .content-row {
      display: flex; gap: 15px; flex: 1; min-height: 0; 
    }
    .col-table {
      flex: 2; display: flex; flex-direction: column;
      background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius);
      overflow: hidden; 
    }
    .col-charts {
      flex: 1; display: flex; flex-direction: column; gap: 15px;
    }
    .chart-card {
      flex: 1; background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius);
      padding: 10px; display: flex; flex-direction: column;
      min-height: 0;
    }
    .chart-container { flex: 1; position: relative; width: 100%; min-height: 0; }

    /* Tabela */
    .table-header { padding: 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.1); gap: 10px; }
    .table-scroll { flex: 1; overflow-y: auto; overflow-x: hidden; }
    
    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    th {
      position: sticky; top: 0; background: #1e293b; z-index: 10;
      text-align: left; padding: 10px; color: var(--text-muted); text-transform: uppercase; font-size: 10px; border-bottom: 1px solid var(--border);
    }
    td { padding: 8px 10px; border-bottom: 1px solid var(--border); vertical-align: middle; }
    tr:hover td { background: rgba(255,255,255,0.02); }

    /* UI Components */
    .card-title { font-size: 13px; font-weight: 700; color: var(--text-main); margin-bottom: 5px; }
    .badge { padding: 3px 6px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; display: inline-block; }
    .badge.info { background: rgba(6, 182, 212, 0.15); color: var(--info); border: 1px solid rgba(6, 182, 212, 0.3); }
    .badge.success { background: rgba(16, 185, 129, 0.15); color: var(--success); border: 1px solid rgba(16, 185, 129, 0.3); }
    .badge.warning { background: rgba(245, 158, 11, 0.15); color: var(--warning); border: 1px solid rgba(245, 158, 11, 0.3); }
    .badge.danger { background: rgba(239, 68, 68, 0.15); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.3); }
    
    @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 50% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
    .badge.piscar { animation: pulse-red 1.5s infinite; border: 1px solid var(--danger); }

    .late-tag {
        display: inline-flex; align-items: center; gap: 4px;
        background: rgba(239, 68, 68, 0.15); border: 1px solid var(--danger); color: var(--danger);
        font-weight: 800; font-size: 11px; padding: 2px 6px; border-radius: 4px; margin-top: 4px;
    }

    input, select { background: rgba(0,0,0,0.3); border: 1px solid var(--border); color: white; padding: 6px 10px; border-radius: 4px; outline: none; font-size: 12px; }
    select option { background: #1e293b; color: white; }
    
    .btn { background: var(--surface); border: 1px solid var(--border); color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .btn.primary { background: var(--primary); border: none; }
    .btn.sm { font-size: 10px; padding: 3px 6px; }

    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }

    .drawer-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 100; opacity: 0; visibility: hidden; transition: 0.3s; }
    .drawer-overlay.open { opacity: 1; visibility: visible; }
    .drawer-panel { position: absolute; top: 10px; bottom: 10px; right: 10px; width: 500px; background: #1e293b; border: 1px solid var(--border); border-radius: 12px; display: flex; flex-direction: column; transform: translateX(100%); transition: 0.3s; box-shadow: -10px 0 30px rgba(0,0,0,0.5); }
    .drawer-overlay.open .drawer-panel { transform: translateX(0); }
    .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 999; }
    .toast { background: var(--surface); border-left: 4px solid var(--primary); padding: 10px 15px; margin-top: 10px; border-radius: 4px; display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s; border: 1px solid var(--border); }
    @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    
    .normal-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 15px; overflow-y: auto; padding-right: 5px; }
    .col-12 { grid-column: span 12; } .col-4 { grid-column: span 4; } .col-8 { grid-column: span 8; }
    .card { background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius); padding: 15px; }
    .form-row { display: flex; gap: 10px; margin-bottom: 10px; } .form-group { flex: 1; } label { display: block; font-size: 10px; color: var(--text-muted); margin-bottom: 3px; text-transform: uppercase; }
  </style>
</head>

<body>
  <header>
    <div class="top-bar">
      <div class="brand">
        <span class="material-symbols-rounded" style="color:var(--primary)">hvac</span>
        <div class="brand-text"><h1>SUPORTE MANUTENÇÃO</h1><p>Painel de Gestão</p></div>
      </div>
      
      <div style="display: flex; align-items: center;">
        <div class="datetime-box">
            <div class="clock-time" id="realTimeClock">--:--:--</div>
            <div class="clock-date" id="realTimeDate">--/--/----</div>
        </div>

        <nav>
          <button class="tab active" data-tab="dash"><span class="material-symbols-rounded" style="font-size:16px">dashboard</span> Dash</button>
          <button class="tab" data-tab="clientes"><span class="material-symbols-rounded" style="font-size:16px">business</span> Clientes</button>
          <button class="tab" data-tab="os"><span class="material-symbols-rounded" style="font-size:16px">assignment</span> OS</button>
          <button class="tab" data-tab="colabs"><span class="material-symbols-rounded" style="font-size:16px">group</span> Equipe</button>
          <button class="tab" data-tab="config"><span class="material-symbols-rounded" style="font-size:16px">settings</span></button>
        </nav>
      </div>
    </div>
  </header>

  <main class="wrap">
    
    <section id="sec-dash" class="section active">
      
      <div class="kpi-row" id="kpiContainer"></div>

      <div class="content-row">
        
        <div class="col-table">
          <div class="table-header">
            <div style="display:flex; flex-direction:column;">
                <div class="card-title" style="margin:0">Carteira de Clientes</div>
                <div style="font-size:10px; color:var(--text-muted)">Monitoramento PMOC</div>
            </div>
            
            <div style="display:flex; gap:10px;">
                <select id="dashSort" style="width: 140px;">
                    <option value="name">Ordem A-Z</option>
                    <option value="equip_desc">Mais Equipamentos</option>
                    <option value="equip_asc">Menos Equipamentos</option>
                    <option value="atraso">Atrasados Primeiro</option>
                </select>
                <input id="dashSearch" placeholder="Buscar cliente..." style="width: 150px;" />
            </div>
          </div>
          
          <div class="table-scroll">
            <table>
              <thead>
                <tr>
                  <th>Cliente</th>
                  <th style="width:100px; text-align:center">Status</th>
                  <th style="text-align:center">Progresso (Prev)</th>
                  <th style="text-align:right">Prazo Limite</th>
                  <th style="text-align:right">Detalhes</th>
                </tr>
              </thead>
              <tbody id="dashTableBody"></tbody>
            </table>
          </div>
        </div>

        <div class="col-charts">
          <div class="chart-card">
            <div class="card-title">Programado x Realizado (14d)</div>
            <div class="chart-container">
              <canvas id="chartLine"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <div class="card-title">Progresso Preventivas (Equipamentos)</div>
            <div class="chart-container">
              <canvas id="chartBar"></canvas>
            </div>
          </div>
        </div>

      </div>
    </section>

    <section id="sec-clientes" class="section">
      <div class="normal-grid">
        <div class="col-4 card">
          <div class="card-title">Novo Cliente</div>
          <input type="hidden" id="cli_id" />
          <div class="form-row"><div class="form-group"><label>Nome</label><input id="cli_nome" style="width:100%" /></div></div>
          <div class="form-row"><div class="form-group"><label>Prazo</label><input type="date" id="cli_limite" style="width:100%" /></div></div>
          <div class="form-row"><div class="form-group"><label>Qtd</label><input type="number" id="cli_qtd" style="width:100%" /></div><div class="form-group"><label>Meta</label><input type="number" id="cli_meta" style="width:100%" /></div></div>
          <div class="form-row"><div class="form-group"><label>Resp.</label><select id="cli_resp" style="width:100%"></select></div></div>
          <div class="form-row"><button class="btn primary" id="btnCliSave" style="flex:1">Salvar</button><button class="btn" id="btnCliClear">Limpar</button></div>
        </div>
        <div class="col-8 card">
          <div class="card-title">Carteira</div>
          <input id="cliSearch" placeholder="Buscar..." style="width:100%; margin-bottom:10px" />
          <div style="height:400px; overflow-y:auto">
            <table><thead><tr><th>Nome</th><th>Qtd. Equip</th><th>Prazo</th><th>Opções</th></tr></thead><tbody id="cliTableBody"></tbody></table>
          </div>
        </div>
      </div>
    </section>

    <section id="sec-os" class="section">
      <div class="normal-grid">
        <div class="col-12 card">
          <div style="display:flex; justify-content:space-between; margin-bottom:10px">
            <button class="btn primary" onclick="openOSModal()">+ Nova OS</button>
            <div style="display:flex; gap:10px">
              <select id="osFilterStatus"><option value="">Todos</option><option>Aberta</option><option>Parcial</option><option>Fechada</option></select>
              <input id="osSearch" placeholder="Buscar..." />
            </div>
          </div>
          <div style="height: calc(100vh - 160px); overflow-y:auto">
             <table>
               <thead><tr><th>Data</th><th>Cliente</th><th>Tipo</th><th>Status</th><th>Progresso</th><th>Resp.</th><th class="text-right">Ação</th></tr></thead>
               <tbody id="osTableBody"></tbody>
             </table>
          </div>
        </div>
      </div>
    </section>

    <section id="sec-colabs" class="section">
      <div class="normal-grid">
        <div class="col-4 card">
          <div class="card-title">Técnico</div>
          <input type="hidden" id="co_id" />
          <div class="form-group"><label>Nome</label><input id="co_nome" style="width:100%" /></div>
          <div class="form-row" style="margin-top:10px"><div class="form-group"><label>Prev/dia</label><input id="co_prev" type="number" style="width:100%"/></div><div class="form-group"><label>Corr/dia</label><input id="co_corr" type="number" style="width:100%"/></div></div>
          <button class="btn primary" id="btnCoSave" style="width:100%; margin-top:10px">Salvar</button>
          <button class="btn" id="btnCoClear" style="width:100%; margin-top:5px">Cancelar</button>
        </div>
        <div class="col-8 card">
          <div class="card-title">Equipe</div>
          <table><thead><tr><th>Nome</th><th>Meta Prev</th><th>Meta Corr</th><th>Ação</th></tr></thead><tbody id="coTableBody"></tbody></table>
        </div>
      </div>
    </section>

    <section id="sec-config" class="section">
      <div class="card" style="max-width:400px">
        <div class="card-title">Backup de Dados</div>
        <div style="display:flex; gap:10px; margin-top:10px">
          <button class="btn" id="btnExport">Exportar JSON</button>
          <label class="btn danger">Importar JSON<input type="file" id="fileImport" accept=".json" style="display:none"/></label>
        </div>
      </div>
    </section>

  </main>

  <div class="drawer-overlay" id="drawerOS">
    <div class="drawer-panel">
      <div style="padding:15px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between">
        <span class="card-title" id="osDrawerTitle">OS Detalhes</span>
        <button class="btn sm" onclick="closeDrawerOS()">✕</button>
      </div>
      <div style="padding:15px; overflow-y:auto; flex:1">
        <div id="osFormContainer" class="hidden">
          <input type="hidden" id="os_id" />
          <div class="form-row"><div class="form-group"><label>Data</label><input type="date" id="os_data" style="width:100%"/></div><div class="form-group"><label>Tipo</label><select id="os_tipo" style="width:100%"><option>Preventiva</option><option>Corretiva</option><option>Instalação</option></select></div></div>
          <div class="form-group"><label>Cliente</label><select id="os_cliente" style="width:100%"></select></div>
          <div class="form-row" style="margin-top:10px"><div class="form-group"><label>Técnico</label><select id="os_colab" style="width:100%"></select></div><div class="form-group"><label>Qtd Prog.</label><input type="number" id="os_prog" style="width:100%"/></div></div>
          <div class="form-group" style="margin-top:10px"><label>Obs</label><textarea id="os_obs" rows="3" style="width:100%; background:rgba(0,0,0,0.3); border:1px solid var(--border); color:white; border-radius:4px"></textarea></div>
          <div style="margin-top:15px; display:flex; gap:10px"><button class="btn primary" id="btnOSSave" style="flex:1">Salvar</button><button class="btn" onclick="closeDrawerOS()">Cancelar</button></div>
        </div>
        <div id="osExecContainer">
          <div style="background:rgba(0,0,0,0.2); padding:10px; border-radius:8px; margin-bottom:15px">
             <div style="display:flex; justify-content:space-between; margin-bottom:5px"><span style="font-size:11px; color:var(--text-muted)">Progresso</span><span style="font-weight:700; font-size:12px" id="osExecProgTxt">0/0</span></div>
             <div style="height:6px; background:rgba(255,255,255,0.1); border-radius:3px; overflow:hidden"><div id="osExecBar" style="height:100%; background:var(--primary); width:0%"></div></div>
             <div id="osExecObs" style="margin-top:8px; font-size:11px; font-style:italic; color:var(--text-muted)"></div>
             <button class="btn sm" id="btnEditCurrentOS" style="margin-top:10px; width:100%">Editar Dados</button>
          </div>
          <div class="card" style="padding:10px; margin-bottom:15px">
            <div class="card-title">Lançar Execução</div>
            <div style="display:flex; gap:10px; align-items:flex-end">
              <div class="form-group"><label>Data</label><input type="date" id="exec_data" style="width:100%"/></div>
              <div class="form-group"><label>Qtd</label><input type="number" id="exec_qtd" style="width:100%"/></div>
              <button class="btn primary" id="btnAddExec">OK</button>
            </div>
          </div>
          <table><thead><tr><th>Data</th><th>Qtd</th><th></th></tr></thead><tbody id="execTableBody"></tbody></table>
        </div>
      </div>
    </div>
  </div>
  <div class="toast-container" id="toastContainer"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getFirestore, collection, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
    
    Chart.register(ChartDataLabels);
    
    const firebaseConfig = { apiKey: "AIzaSyAK_HgzYUlc7od-gqJOkEAnOedmY4KJ66w", authDomain: "manutencao-suporte.firebaseapp.com", projectId: "manutencao-suporte", storageBucket: "manutencao-suporte.firebasestorage.app", messagingSenderId: "522009429363", appId: "1:522009429363:web:24ecfbf3306d2aa7cf3106" };
    const app = initializeApp(firebaseConfig); const db = getFirestore(app);

    let state = { clientes: [], os: [], colabs: [], editingOSId: null };
    let chartLines = null, chartBars = null;
    const $ = id => document.getElementById(id);
    const todayISO = () => new Date(new Date().getTime() - new Date().getTimezoneOffset() * 60000).toISOString().split('T')[0];
    const fmtDate = (iso) => iso ? iso.split("-").reverse().join("/") : "-";
    const showToast = (msg, type='info') => { const el = document.createElement("div"); el.className = `toast ${type}`; el.innerHTML = `<span>${msg}</span>`; $("toastContainer").appendChild(el); setTimeout(() => el.remove(), 3000); };

    // --- RELÓGIO TEMPO REAL ---
    function startClock() {
        setInterval(() => {
            const now = new Date();
            $('realTimeClock').innerText = now.toLocaleTimeString('pt-BR');
            $('realTimeDate').innerText = now.toLocaleDateString('pt-BR');
        }, 1000);
    }
    startClock();

    // --- LOGIC ---
    const getStatusOS = (os) => {
      const ex = (os.exec || []).reduce((a, b) => a + Number(b.qtd), 0);
      const prog = Number(os.qtdProg || 1);
      return ex <= 0 ? "Aberta" : (ex >= prog ? "Fechada" : "Parcial");
    };

    function renderCharts() {
      if (!$("chartLine") || !$("chartBar")) return;
      Chart.defaults.color = '#94a3b8'; Chart.defaults.borderColor = 'rgba(255,255,255,0.05)'; Chart.defaults.font.size = 10;

      const labels = [], dProg = [], dReal = [];
      for (let i = 13; i >= 0; i--) {
        const d = new Date(); d.setDate(d.getDate() - i);
        const iso = d.toISOString().split('T')[0];
        labels.push(`${d.getDate()}/${d.getMonth()+1}`);
        let pSum = 0, rSum = 0;
        state.os.forEach(o => {
          if (o.data === iso) pSum += Number(o.qtdProg || 0);
          if (o.exec) o.exec.forEach(e => { if (e.data === iso) rSum += Number(e.qtd || 0); });
        });
        dProg.push(pSum); dReal.push(rSum);
      }

      // --- FILTRO: CONTAGEM DE EQUIPAMENTOS PREVENTIVOS ---
      let totalProg = 0;
      let totalExec = 0;

      state.os.filter(o => o.tipo === "Preventiva").forEach(o => {
         const prog = Number(o.qtdProg || 1);
         const exec = (o.exec || []).reduce((a, b) => a + Number(b.qtd), 0);
         totalProg += prog;
         totalExec += exec;
      });

      const totalPend = Math.max(0, totalProg - totalExec);

      if (chartLines) chartLines.destroy();
      chartLines = new Chart($('chartLine'), {
        type: 'line',
        data: { labels, datasets: [{ label: 'Planejado', data: dProg, borderColor: '#3b82f6', tension: 0.3, fill: false }, { label: 'Realizado', data: dReal, borderColor: '#10b981', tension: 0.3, fill: false }] },
        options: { 
            responsive: true, 
            maintainAspectRatio: false, 
            plugins: { 
                legend: { position: 'top', labels: {boxWidth: 8} }, 
                datalabels: { 
                    display: 'auto',
                    align: 'top',
                    color: '#fff',
                    font: { weight: 'bold' },
                    formatter: (value) => value > 0 ? value : ''
                } 
            }, 
            scales: { x: { grid: { display: false } } } 
        }
      });

      if (chartBars) chartBars.destroy();
      chartBars = new Chart($('chartBar'), {
        type: 'doughnut',
        data: { 
            labels: ['Equip. Pendentes', 'Equip. Realizados'], 
            datasets: [{ 
                data: [totalPend, totalExec], 
                backgroundColor: ['#f59e0b', '#10b981'], 
                borderWidth: 0 
            }] 
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false, 
            cutout: '60%', 
            plugins: { 
                legend: { position: 'right', labels: {boxWidth: 8} }, 
                datalabels: { 
                    color: 'white',
                    font: { weight: 'bold' },
                    formatter: (value) => value > 0 ? value : ''
                } 
            } 
        }
      });
    }

    function renderKPIs() {
      const totCli = state.clientes.length;
      let atrasados = 0, totEquip = 0;
      state.clientes.forEach(c => {
         totEquip += (Number(c.qtdEquip)||0);
         const m = Number(c.metaPrev) || Number(c.qtdEquip) || 0;
         if (m > 0 && c.dataLimite && todayISO() > c.dataLimite) {
            const feitos = state.os.filter(o => o.clienteId === c.id && o.tipo === 'Preventiva').reduce((a, o) => a + (o.exec || []).reduce((x, y) => x + Number(y.qtd), 0), 0);
            if (feitos < m) atrasados++;
         }
      });
      let pPlan = 0, pReal = 0, cReal = 0;
      state.os.forEach(o => {
         const ex = (o.exec || []).reduce((a, b) => a + Number(b.qtd), 0);
         if (o.tipo === 'Preventiva') { pPlan += Number(o.qtdProg || 0); pReal += ex; }
         else if (o.tipo === 'Corretiva') cReal += ex;
      });

      const kpis = [
        { l: "Clientes", v: totCli, c: "var(--info)", i: "domain" },
        { l: "Atrasados", v: atrasados, c: "var(--danger)", i: "timer_off" },
        { l: "Equipamentos", v: totEquip, c: "var(--warning)", i: "hvac" },
        { l: "Prev. Plan", v: pPlan, c: "var(--primary)", i: "event_note" },
        { l: "Prev. Real", v: pReal, c: "var(--success)", i: "check_circle" },
        { l: "Corr. Real", v: cReal, c: "var(--purple)", i: "build" }
      ];
      $("kpiContainer").innerHTML = kpis.map(k => `
        <div class="kpi-box" style="border-left:3px solid ${k.c}">
          <div><div style="font-size:10px;color:var(--text-muted)">${k.l}</div><div class="kpi-val" style="color:${k.c}">${k.v}</div></div>
          <span class="material-symbols-rounded" style="color:${k.c}; opacity:0.3; font-size:24px">${k.i}</span>
        </div>
      `).join("");
    }

    function renderDashTable() {
      const q = ($("dashSearch").value || "").toLowerCase();
      const sortMode = $("dashSort").value;
      
      // 1. Filtrar
      let list = state.clientes.filter(c => c.nome.toLowerCase().includes(q));

      // 2. Ordenar
      list.sort((a,b) => {
          if (sortMode === 'name') return a.nome.localeCompare(b.nome);
          
          if (sortMode === 'equip_desc') {
              return (Number(b.qtdEquip)||0) - (Number(a.qtdEquip)||0);
          }
          
          if (sortMode === 'equip_asc') {
              return (Number(a.qtdEquip)||0) - (Number(b.qtdEquip)||0);
          }

          if (sortMode === 'atraso') {
              const metaA = Number(a.metaPrev) || Number(a.qtdEquip) || 0;
              const metaB = Number(b.metaPrev) || Number(b.qtdEquip) || 0;
              // Logica simplificada: prioriza quem tem data limite vencida
              const atrasadoA = (a.dataLimite && todayISO() > a.dataLimite) ? 1 : 0;
              const atrasadoB = (b.dataLimite && todayISO() > b.dataLimite) ? 1 : 0;
              return atrasadoB - atrasadoA; 
          }
          return 0;
      });

      const rows = list.map(c => {
        const meta = Number(c.metaPrev) || Number(c.qtdEquip) || 0;
        const exec = state.os.filter(o => o.clienteId === c.id && o.tipo === 'Preventiva').reduce((a, o) => a + (o.exec || []).reduce((x, y) => x + Number(y.qtd), 0), 0);
        const pct = meta > 0 ? Math.min(100, Math.round((exec / meta) * 100)) : 0;
        
        let st = `<span class="badge info">Em Dia</span>`;
        let diasAtrasoHtml = '';

        if (meta > 0 && exec >= meta) {
            st = `<span class="badge success">Concluído</span>`;
        } else if (c.dataLimite && todayISO() > c.dataLimite) {
            st = `<span class="badge danger piscar">Atrasado</span>`;
            const d1 = new Date(todayISO()); const d2 = new Date(c.dataLimite);
            const diffDays = Math.ceil(Math.abs(d1 - d2) / (1000 * 60 * 60 * 24)); 
            diasAtrasoHtml = `<br><div class="late-tag">⚠️ +${diffDays} dias</div>`;
        }

        return `
          <tr>
            <td style="font-weight:700">
                ${c.nome}
                <div style="font-size:10px; font-weight:400; color:var(--text-muted)">${Number(c.qtdEquip)||0} Equip.</div>
            </td>
            <td style="text-align:center">${st}</td>
            <td style="text-align:center">
              <div style="display:flex; align-items:center; gap:5px; justify-content:center">
                <div style="flex:1; height:6px; background:rgba(255,255,255,0.1); border-radius:3px; overflow:hidden; max-width:100px"><div style="width:${pct}%; background:var(--primary); height:100%"></div></div>
                <span style="font-size:10px">${exec}/${meta}</span>
              </div>
            </td>
            <td style="text-align:right">
                ${fmtDate(c.dataLimite)}
                ${diasAtrasoHtml}
            </td>
            <td style="text-align:right"><button class="btn sm" onclick="window.detalhe('${c.id}')">Ver</button></td>
          </tr>
        `;
      });
      $("dashTableBody").innerHTML = rows.join("");
    }

    // --- SETUP ---
    document.querySelectorAll(".tab").forEach(t => t.onclick = () => {
      document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
      document.querySelectorAll(".section").forEach(x => x.classList.remove("active"));
      t.classList.add("active"); $("sec-" + t.dataset.tab).classList.add("active");
    });
    
    // Listeners Search & Sort
    $("dashSearch").oninput = renderDashTable;
    $("dashSort").onchange = renderDashTable; // Trigger de ordenação

    $("cliSearch").oninput = () => {
       const q = $("cliSearch").value.toLowerCase();
       $("cliTableBody").innerHTML = state.clientes.filter(c=>c.nome.toLowerCase().includes(q)).map(c=>`<tr><td>${c.nome}</td><td>${Number(c.qtdEquip)||0}</td><td>${fmtDate(c.dataLimite)}</td><td><button class="btn sm" onclick="window.editCli('${c.id}')">Ed</button> <button class="btn sm danger" onclick="window.delCli('${c.id}')">Ex</button></td></tr>`).join("");
    };
    $("osSearch").oninput = renderOSTable;
    
    function renderOSTable(){
        const q=$("osSearch").value.toLowerCase(); const fs=$("osFilterStatus").value;
        $("osTableBody").innerHTML = state.os.filter(o => {
            const cn = state.clientes.find(c=>c.id===o.clienteId)?.nome||"";
            return (cn.toLowerCase().includes(q)|| (o.obs||"").toLowerCase().includes(q)) && (!fs || getStatusOS(o)===fs);
        }).sort((a,b)=>b.data.localeCompare(a.data)).map(o=>{
            const c=state.clientes.find(x=>x.id===o.clienteId); const r=state.colabs.find(x=>x.id===o.colabId); const st=getStatusOS(o);
            const badge = st==="Fechada"?"success":st==="Parcial"?"warning":"info";
            const ex=(o.exec||[]).reduce((a,b)=>a+Number(b.qtd),0); const tot=o.qtdProg||1;
            return `<tr><td>${fmtDate(o.data)}</td><td>${c?c.nome:"?"}</td><td>${o.tipo}</td><td><span class="badge ${badge}">${st}</span></td><td>${ex}/${tot}</td><td>${r?r.nome:"-"}</td><td class="text-right"><button class="btn sm" onclick="window.openOS('${o.id}')">Abrir</button></td></tr>`;
        }).join("");
    }

    // --- ACTIONS ---
    window.detalhe = (id) => { $("tab-os").click(); document.querySelector('[data-tab="os"]').click(); setTimeout(()=>{ const c=state.clientes.find(x=>x.id===id); if(c){ $("osSearch").value=c.nome; renderOSTable();} },100); };
    
    // CRUD CLIENTE
    window.editCli=(id)=>{ const c=state.clientes.find(x=>x.id===id); $("cli_id").value=c.id; $("cli_nome").value=c.nome; $("cli_limite").value=c.dataLimite; $("cli_qtd").value=c.qtdEquip; $("cli_meta").value=c.metaPrev||""; $("cli_resp").value=c.respId; };
    window.delCli=async(id)=>{ if(confirm("Apagar?")) { await deleteDoc(doc(db,"clientes",id)); showToast("Removido"); }};
    $("btnCliSave").onclick=async()=>{ const id=$("cli_id").value; const d={nome:$("cli_nome").value, dataLimite:$("cli_limite").value, qtdEquip:Number($("cli_qtd").value), metaPrev:$("cli_meta").value, respId:$("cli_resp").value, updatedAt:serverTimestamp()}; if(!d.nome)return; if(id) await updateDoc(doc(db,"clientes",id),d); else await addDoc(collection(db,"clientes"),d); showToast("Salvo"); $("btnCliClear").click(); };
    $("btnCliClear").onclick=()=>{ $("cli_id").value=""; $("cli_nome").value=""; $("cli_limite").value=""; $("cli_qtd").value=""; $("cli_meta").value=""; };

    // CRUD COLAB
    window.editCo=(id)=>{ const c=state.colabs.find(x=>x.id===id); $("co_id").value=c.id; $("co_nome").value=c.nome; $("co_prev").value=c.prevDia; $("co_corr").value=c.corrDia; };
    $("btnCoClear").onclick=()=>{ $("co_id").value=""; $("co_nome").value=""; $("co_prev").value=""; $("co_corr").value=""; };
    $("btnCoSave").onclick=async()=>{ const id=$("co_id").value; const d={nome:$("co_nome").value, prevDia:Number($("co_prev").value), corrDia:Number($("co_corr").value)}; if(!d.nome)return; if(id) await updateDoc(doc(db,"colabs",id),d); else await addDoc(collection(db,"colabs"),d); showToast("Salvo"); $("btnCoClear").click(); };

    // CRUD OS
    window.openOSModal=()=>{ $("os_id").value=""; $("os_data").value=todayISO(); $("os_prog").value=1; $("os_obs").value=""; $("osFormContainer").classList.remove("hidden"); $("osExecContainer").classList.add("hidden"); $("osDrawerTitle").innerText="Nova OS"; $("drawerOS").classList.add("open"); };
    window.openOS=(id)=>{ const os=state.os.find(o=>o.id===id); if(!os)return; state.editingOSId=id; renderOSExec(os); $("osFormContainer").classList.add("hidden"); $("osExecContainer").classList.remove("hidden"); $("osDrawerTitle").innerText=`OS #${id.slice(0,4)}`; $("drawerOS").classList.add("open"); };
    function renderOSExec(os){ const t=Number(os.qtdProg||1); const ex=(os.exec||[]).reduce((a,b)=>a+Number(b.qtd),0); const p=Math.min(100,Math.round((ex/t)*100)); $("osExecProgTxt").innerText=`${ex}/${t} (${p}%)`; $("osExecBar").style.width=p+"%"; $("osExecObs").innerText=os.obs||""; $("exec_data").value=todayISO(); $("exec_qtd").value=1; $("execTableBody").innerHTML=(os.exec||[]).map((e,i)=>`<tr><td>${fmtDate(e.data)}</td><td>${e.qtd}</td><td><button class="btn sm danger" onclick="window.rmOSItem('${os.id}',${i})">x</button></td></tr>`).join(""); }
    $("btnOSSave").onclick=async()=>{ const id=$("os_id").value; const d={data:$("os_data").value, tipo:$("os_tipo").value, clienteId:$("os_cliente").value, colabId:$("os_colab").value, qtdProg:Number($("os_prog").value), obs:$("os_obs").value}; if(id) await updateDoc(doc(db,"os",id),d); else await addDoc(collection(db,"os"),{...d, exec:[], createdAt:serverTimestamp()}); showToast("Salvo"); window.closeDrawerOS(); };
    $("btnEditCurrentOS").onclick=()=>{ const os=state.os.find(o=>o.id===state.editingOSId); $("os_id").value=os.id; $("os_data").value=os.data; $("os_tipo").value=os.tipo; $("os_cliente").value=os.clienteId; $("os_colab").value=os.colabId; $("os_prog").value=os.qtdProg; $("os_obs").value=os.obs; $("osFormContainer").classList.remove("hidden"); $("osExecContainer").classList.add("hidden"); };
    $("btnAddExec").onclick=async()=>{ const os=state.os.find(o=>o.id===state.editingOSId); const q=Number($("exec_qtd").value); const d=$("exec_data").value; const cur=(os.exec||[]).reduce((a,b)=>a+Number(b.qtd),0); if(cur+q>os.qtdProg) return showToast("Excede Qtd!","error"); const ne=[...(os.exec||[]),{data:d, qtd:q}]; await updateDoc(doc(db,"os",os.id),{exec:ne}); renderOSExec({...os, exec:ne}); };
    window.rmOSItem=async(oid,i)=>{ const os=state.os.find(o=>o.id===oid); const ne=[...os.exec]; ne.splice(i,1); await updateDoc(doc(db,"os",oid),{exec:ne}); renderOSExec({...os, exec:ne}); };
    window.closeDrawerOS=()=>{ $("drawerOS").classList.remove("open"); };

    // INIT
    onSnapshot(collection(db,"clientes"),s=>{ state.clientes=s.docs.map(d=>({id:d.id,...d.data()})); $("os_cliente").innerHTML=state.clientes.map(c=>`<option value="${c.id}">${c.nome}</option>`).join(""); renderDashTable(); renderKPIs(); $("cliSearch").oninput(); });
    onSnapshot(collection(db,"os"),s=>{ state.os=s.docs.map(d=>({id:d.id,...d.data()})); renderOSTable(); renderDashTable(); renderKPIs(); renderCharts(); if(state.editingOSId && $("drawerOS").classList.contains("open")) renderOSExec(state.os.find(o=>o.id===state.editingOSId)); });
    onSnapshot(collection(db,"colabs"),s=>{ state.colabs=s.docs.map(d=>({id:d.id,...d.data()})); const h=state.colabs.map(c=>`<option value="${c.id}">${c.nome}</option>`).join(""); $("cli_resp").innerHTML=`<option value="">Sem Resp.</option>`+h; $("os_colab").innerHTML=h; $("coTableBody").innerHTML=state.colabs.map(c=>`<tr><td>${c.nome}</td><td>${c.prevDia||0}</td><td>${c.corrDia||0}</td><td><button class="btn sm" onclick="window.editCo('${c.id}')">Ed</button></td></tr>`).join(""); });

    // EXPORT
    $("btnExport").onclick=()=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(state)],{type:"application/json"})); a.download=`pcm_${todayISO()}.json`; a.click(); };
    $("fileImport").onchange=(e)=>{ const r=new FileReader(); r.onload=async(ev)=>{ const d=JSON.parse(ev.target.result); if(d.clientes)for(let c of d.clientes)await setDoc(doc(db,"clientes",c.id),c); if(d.os)for(let o of d.os)await setDoc(doc(db,"os",o.id),o); if(d.colabs)for(let k of d.colabs)await setDoc(doc(db,"colabs",k.id),k); showToast("Importado"); }; r.readAsText(e.target.files[0]); };

  </script>
</body>
</html>
